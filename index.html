<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clinik Pro | Access</title>
    <style>
        :root { --primary: #6366f1; --soft-bg: #c7d2fe; --muted: #94a3b8; }
        body { background: var(--muted); font-family: 'Inter', sans-serif; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; }
        .card { background: white; width: 850px; display: flex; border-radius: 40px; overflow: hidden; box-shadow: 0 20px 50px rgba(0,0,0,0.2); min-height: 550px; }
        .left { width: 40%; background: var(--soft-bg); padding: 40px; color: #4338ca; display: flex; flex-direction: column; justify-content: space-between; }
        .right { width: 60%; padding: 50px; display: none; flex-direction: column; justify-content: center; }
        .right.active { display: flex; }
        input, select { width: 100%; border: none; border-bottom: 1px solid #ddd; padding: 12px 0; outline: none; margin-bottom: 20px; font-size: 1rem; background: transparent; }
        .btn-main { width: 100%; padding: 15px; background: var(--primary); color: white; border: none; border-radius: 12px; font-weight: 700; cursor: pointer; margin-top: 10px; }
        .footer { text-align: center; margin-top: 20px; font-size: 0.9rem; color: #888; }
        .link { color: var(--primary); font-weight: bold; cursor: pointer; }
        .ts-group { display: flex; gap: 10px; }
        label { font-size: 0.8rem; color: var(--muted); font-weight: bold; text-transform: uppercase; }
        .hidden { display: none; }
    </style>
</head>
<body>

<div class="card">
    <div class="left">
        <div>
            <h2>Clinik Pro</h2>
            <p>Secure Healthcare Access. Monitor your vitals and manage appointments seamlessly.</p>
        </div>
        <img src="https://cdn-icons-png.flaticon.com/512/3063/3063176.png" alt="Stethoscope" width="100%">
    </div>

    <div class="right" id="reg-view">
        <h2>Create Account</h2>
        <form id="regForm">
            <label>Register As:</label>
            <select id="regRole" onchange="toggleRegFields()">
                <option value="patient">I am a Patient</option>
                <option value="doctor">I am a Doctor</option>
            </select>
            <input type="text" id="regName" placeholder="Full Name" required>
            <label>Date of Birth:</label>
            <input type="date" id="regDOB" required>
            <div id="reg-doc-fields" class="hidden">
                <input type="email" id="regEmail" placeholder="Email Address">
                <input type="password" id="regPass" placeholder="Create Password">
            </div>
            <div id="reg-ts-fields">
                <div class="ts-group">
                    <input type="text" id="regTSID" placeholder="ThingSpeak ID">
                    <input type="text" id="regTSKey" placeholder="Read Key">
                </div>
            </div>
            <button type="submit" class="btn-main">Create Account</button>
        </form>
        <p class="footer">Already have an Account? <span class="link" onclick="showView('log-view')">Log in</span></p>
    </div>

    <div class="right active" id="log-view">
        <h2>Welcome Back</h2>
        <form id="loginForm">
            <label>Login As:</label>
            <select id="loginRole" onchange="toggleLoginFields()" required>
                <option value="patient">Patient</option>
                <option value="doctor">Doctor</option>
            </select>
            <div id="doctor-only-fields" class="hidden">
                <input type="email" id="loginEmail" placeholder="Email Address">
                <input type="password" id="loginPass" placeholder="Password">
            </div>
            <div id="patient-only-fields">
                <label>Vitals Access:</label>
                <input type="text" id="channelID" placeholder="ThingSpeak ID">
                <input type="text" id="apiKey" placeholder="Read API Key">
            </div>
            <button type="submit" class="btn-main">Login to Dashboard</button>
        </form>
        <p class="footer">New user? <span class="link" onclick="showView('reg-view')">Register</span></p>
    </div>
</div>

<script>
    const API_URL = "http://localhost:5000";

    function showView(id) {
        document.querySelectorAll('.right').forEach(v => v.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    }

    function toggleLoginFields() {
        const isDoc = document.getElementById('loginRole').value === 'doctor';
        document.getElementById('doctor-only-fields').classList.toggle('hidden', !isDoc);
        document.getElementById('patient-only-fields').classList.toggle('hidden', isDoc);
    }

    function toggleRegFields() {
        const isDoc = document.getElementById('regRole').value === 'doctor';
        document.getElementById('reg-doc-fields').classList.toggle('hidden', !isDoc);
        document.getElementById('reg-ts-fields').classList.toggle('hidden', isDoc);
    }

    document.getElementById('regForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        // Use FormData because the backend uses Multer
        const formData = new FormData();
        formData.append('name', document.getElementById('regName').value);
        formData.append('dob', document.getElementById('regDOB').value);
        formData.append('role', document.getElementById('regRole').value);
        
        if (document.getElementById('regRole').value === 'doctor') {
            formData.append('email', document.getElementById('regEmail').value);
            formData.append('pass', document.getElementById('regPass').value);
        } else {
            formData.append('tsID', document.getElementById('regTSID').value);
            formData.append('tsKey', document.getElementById('regTSKey').value);
        }

        try {
            const response = await fetch(`${API_URL}/register`, {
                method: 'POST',
                body: formData // No Headers needed for FormData
            });

            const result = await response.json();
            if (response.ok) {
                alert("Success! Registered in MongoDB.");
                showView('log-view');
            } else {
                alert("Registration failed: " + (result.error || "Server error"));
            }
        } catch (err) {
            alert("Is server.js running? Check terminal.");
        }
    });

    document.getElementById('loginForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const role = document.getElementById('loginRole').value;
        const loginData = { role };

        if (role === 'doctor') {
            loginData.email = document.getElementById('loginEmail').value;
            loginData.pass = document.getElementById('loginPass').value;
        } else {
            loginData.tsID = document.getElementById('channelID').value;
            loginData.tsKey = document.getElementById('apiKey').value;
        }

        try {
            const response = await fetch(`${API_URL}/login`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(loginData)
            });

            const user = await response.json();
            if (response.ok) {
                localStorage.setItem('userData', JSON.stringify(user));
                window.location.href = (role === 'doctor') ? 'doctordashboard.html' : 'patientdashboard.html';
            } else {
                alert(user.error || "Login Failed");
            }
        } catch (err) {
            alert("Server Error.");
        }
    });

    window.onload = () => { toggleLoginFields(); toggleRegFields(); };
</script>
</body>
</html>
