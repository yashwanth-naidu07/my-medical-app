<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="manifest" href="manifest.json">
<script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('sw.js')
      .then(() => console.log("PWA Registered Successfully"));
  }
</script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>health care | Patient Dashboard</title>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root {
            --primary-blue: #5c67f2;
            --sidebar-blue: #6366f1;
            --bg-gray: #f4f7fe;
            --card-radius: 24px;
            --text-dark: #2d3748;
            --text-muted: #a0aec0;
            --danger-red: #ef4444;
        }

        * { box-sizing: border-box; font-family: 'Inter', sans-serif; }

        body {
            background-color: var(--bg-gray);
            margin: 0;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* --- SIDEBAR --- */
        .sidebar {
            width: 260px;
            background-color: var(--sidebar-blue);
            color: white;
            display: flex;
            flex-direction: column;
            padding: 30px 20px;
        }

        .logo { font-size: 1.8rem; font-weight: 800; margin-bottom: 40px; letter-spacing: 1px; }

        nav { flex-grow: 1; }
        nav a {
            display: flex;
            align-items: center;
            gap: 15px;
            color: rgba(255,255,255,0.7);
            text-decoration: none;
            padding: 12px 20px;
            border-radius: 12px;
            margin-bottom: 8px;
            transition: 0.3s;
            font-size: 0.95rem;
        }

        nav a.active { background: rgba(255,255,255,0.2); color: white; }
        nav a:hover { background: rgba(255,255,255,0.1); }

        .logout-container { margin-top: auto; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 20px; }
        .logout-btn {
            width: 100%;
            background: #ef4444;
            color: white;
            border: none;
            padding: 12px;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        /* --- MAIN CONTENT --- */
        .main-content {
            flex-grow: 1;
            padding: 30px;
            overflow-y: auto;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .header-title h1 { margin: 0; font-size: 1.5rem; color: var(--text-dark); }

        .grid-layout {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 25px;
        }

        .card {
            background: white;
            border-radius: var(--card-radius);
            padding: 25px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.02);
            border: 1px solid #edf2f7;
            margin-bottom: 20px;
        }

        .vitals-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 20px;
        }

        .vital-mini {
            display: flex;
            align-items: center;
            gap: 15px;
            background: #f8fafc;
            padding: 15px;
            border-radius: 18px;
        }

        .vital-icon {
            width: 40px; height: 40px;
            background: white;
            border-radius: 50%;
            display: flex;
            align-items: center; justify-content: center;
            color: var(--primary-blue);
        }

        /* --- TABLE STYLING --- */
        .history-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 0.9rem;
        }
        .history-table th, .history-table td {
            text-align: left;
            padding: 12px;
            border-bottom: 1px solid #edf2f7;
        }
        .history-table th { color: var(--text-muted); font-weight: 600; }

        .btn-action {
            border: none;
            padding: 8px 15px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 5px;
            font-weight: 600;
        }
        
        .btn-csv { background: #10b981; color: white; float: right; }
        .btn-view { background: var(--primary-blue); color: white; margin-top: 20px; }

        /* --- NOTIFICATION TOASTS --- */
        #alert-toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #333;
            color: white;
            padding: 12px 20px;
            border-radius: 12px;
            display: none;
            animation: slideUp 0.3s ease;
            z-index: 1000;
        }

        #bpm-warning {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--danger-red);
            color: white;
            padding: 15px 25px;
            border-radius: 12px;
            display: none;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.4);
            z-index: 1001;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp { from { transform: translateY(100px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        /* Profile */
        .profile-section { text-align: center; }
        .profile-img {
            width: 100px; height: 100px;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid white;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .btn-edit {
            background: transparent;
            border: 1px solid var(--primary-blue);
            color: var(--primary-blue);
            padding: 8px 20px;
            border-radius: 20px;
            cursor: pointer;
            margin-top: 15px;
        }

        .apt-form { display: flex; flex-direction: column; gap: 15px; }
        .apt-form input, .apt-form select { padding: 12px; border: 1px solid #ddd; border-radius: 10px; }
        .btn-book { background: var(--primary-blue); color: white; border: none; padding: 12px; border-radius: 10px; cursor: pointer; font-weight: 600; }

        .content-view { display: none; }
        .content-view.active { display: block; }

        /* History Container Hidden by Default */
        #history-container { display: none; margin-top: 20px; }
    </style>
</head>
<body>

    <div id="alert-toast">New data synchronized!</div>
    <div id="bpm-warning">⚠️ HEART RATE ALERT!</div>

    <aside class="sidebar">
        <div class="logo">CLINIK</div>
        <nav id="sidebar-nav">
            <a href="#" class="active" onclick="showSection('overview', this)"><i data-lucide="layout-grid"></i> Schedule</a>
            <a href="#" onclick="showSection('appointments', this)"><i data-lucide="calendar"></i> Appointments</a>
            <a href="#" onclick="showSection('analytics', this)"><i data-lucide="bar-chart-2"></i> Statistics</a>
            <a href="#" onclick="showSection('reports', this)"><i data-lucide="file-text"></i> Reports</a>
        </nav>

        <div class="logout-container">
            <button class="logout-btn" onclick="handleLogout()">
                <i data-lucide="log-out"></i> Logout
            </button>
        </div>
    </aside>

    <main class="main-content">
        <header>
            <div class="header-title">
                <h1 id="page-title">Patient profile</h1>
            </div>
            <div class="header-actions">
                <button class="btn-edit">PRINT</button>
                <button class="btn-edit" style="background:var(--primary-blue); color:white;">EDIT</button>
            </div>
        </header>

        <div class="grid-layout">
            <div class="left-col">
                <div id="overview" class="content-view active">
                    <div class="card">
                        <h3>General Information</h3>
                        <div class="vitals-grid">
                            <div class="vital-mini">
                                <div class="vital-icon"><i data-lucide="heart"></i></div>
                                <div><small>Heart Rate</small><p id="val-f1">Loading...</p></div>
                            </div>
                            <div class="vital-mini">
                                <div class="vital-icon"><i data-lucide="thermometer"></i></div>
                                <div><small>Body Temp</small><p id="val-f2">Loading...</p></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="appointments" class="content-view">
                    <div class="card">
                        <h3>Book an Appointment</h3>
                        <form class="apt-form" id="aptForm">
                            <label>Select Date</label>
                            <input type="date" id="aptDate" required>
                            <label>Select Time</label>
                            <input type="time" id="aptTime" required>
                            <label>Department</label>
                            <select id="dept">
                                <option>Cardiology</option>
                                <option>Neurology</option>
                                <option>General Checkup</option>
                            </select>
                            <button type="submit" class="btn-book">Confirm Appointment</button>
                        </form>
                    </div>
                </div>

                <div id="analytics" class="content-view">
                    <div class="card">
                        <button class="btn-action btn-csv" onclick="exportToCSV()">
                            <i data-lucide="download" style="width:14px"></i> Export CSV
                        </button>
                        <h3>Live Health Records</h3>
                        <div class="vitals-grid">
                            <div class="vital-mini">
                                <div><small>Pulse</small><h2 id="stats-heart">--</h2></div>
                            </div>
                            <div class="vital-mini">
                                <div><small>Temp</small><h2 id="stats-temp">--</h2></div>
                            </div>
                        </div>

                        <button class="btn-action btn-view" id="toggle-history-btn" onclick="toggleHistory()">
                            <i data-lucide="history" style="width:16px"></i> Show Record History
                        </button>

                        <div id="history-container">
                            <h4 style="margin-top:20px">Detailed Record Log</h4>
                            <div style="overflow-x:auto;">
                                <table class="history-table">
                                    <thead>
                                        <tr>
                                            <th>Time</th>
                                            <th>Pulse (bpm)</th>
                                            <th>Temp (°C)</th>
                                        </tr>
                                    </thead>
                                    <tbody id="history-body">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="reports" class="content-view">
                    <div class="card">
                        <h3>Medical Reports</h3>
                        <p>No new reports available.</p>
                    </div>
                </div>
            </div>

            <div class="right-col">
                <div class="card profile-section">
                    <img src="https://i.pravatar.cc/150?u=kate" class="profile-img" alt="User">
                    <h2 id="display-name">Kate Prokopchuk</h2>
                    <p style="color:var(--text-muted)">+38 (093) 23 45 678</p>
                    <hr style="border:0; border-top:1px solid #eee; margin:20px 0;">
                    <div style="text-align:left;">
                        <small style="color:var(--text-muted)">Anamnesis</small>
                        <p><strong>Allergies:</strong> Nuts, pollen</p>
                        <p><strong>Blood Type:</strong> B+</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        lucide.createIcons();

        // 1. DATA PERSISTENCE LOGIC
        let healthHistory = JSON.parse(localStorage.getItem('persistentHealthHistory')) || [];

        function renderHistoryTable() {
            const tbody = document.getElementById('history-body');
            tbody.innerHTML = ""; 
            healthHistory.slice().reverse().forEach(record => {
                const row = `<tr><td>${record.time}</td><td>${record.pulse}</td><td>${record.temp}</td></tr>`;
                tbody.insertAdjacentHTML('beforeend', row);
            });
        }

        // Toggle visibility function
        function toggleHistory() {
            const container = document.getElementById('history-container');
            const btn = document.getElementById('toggle-history-btn');
            
            if (container.style.display === "none" || container.style.display === "") {
                container.style.display = "block";
                btn.innerHTML = `<i data-lucide="eye-off" style="width:16px"></i> Hide Record History`;
                renderHistoryTable(); 
            } else {
                container.style.display = "none";
                btn.innerHTML = `<i data-lucide="history" style="width:16px"></i> Show Record History`;
            }
            lucide.createIcons();
        }

        // 2. Navigation
        function showSection(sectionId, element) {
            document.querySelectorAll('.content-view').forEach(v => v.classList.remove('active'));
            document.getElementById(sectionId).classList.add('active');
            document.querySelectorAll('#sidebar-nav a').forEach(a => a.classList.remove('active'));
            element.classList.add('active');
            document.getElementById('page-title').innerText = sectionId.charAt(0).toUpperCase() + sectionId.slice(1);
        }

        // 3. THING SPEAK INTEGRATION
        const CHANNEL_ID = '3218730';
        const READ_API_KEY = 'LD1IMABWITKH2TZK';

        function showSyncAlert() {
            const toast = document.getElementById('alert-toast');
            toast.style.display = 'block';
            setTimeout(() => { toast.style.display = 'none'; }, 2500);
        }

        // NEW BPM NOTIFICATION ALERT
        function checkBpmHealth(bpm) {
            const warning = document.getElementById('bpm-warning');
            const bpmVal = parseInt(bpm);
            
            if (bpmVal > 100) {
                warning.innerHTML = `⚠️ HIGH BPM ALERT: ${bpmVal}`;
                warning.style.display = 'block';
                setTimeout(() => { warning.style.display = 'none'; }, 5000);
            } else if (bpmVal < 60 && bpmVal > 0) {
                warning.innerHTML = `⚠️ LOW BPM ALERT: ${bpmVal}`;
                warning.style.display = 'block';
                setTimeout(() => { warning.style.display = 'none'; }, 5000);
            } else {
                warning.style.display = 'none';
            }
        }

        async function fetchHealthData() {
            try {
                const response = await fetch(`https://api.thingspeak.com/channels/${CHANNEL_ID}/feeds.json?api_key=${READ_API_KEY}&results=1`);
                const data = await response.json();
                const lastFeed = data.feeds[0];

                if (lastFeed) {
                    const pulse = lastFeed.field1 || '0';
                    const temp = lastFeed.field2 || '0';
                    const time = new Date().toLocaleString();

                    // Update UI
                    document.getElementById('val-f1').innerText = pulse + " bpm";
                    document.getElementById('val-f2').innerText = temp + " °C";
                    document.getElementById('stats-heart').innerText = pulse + " bpm";
                    document.getElementById('stats-temp').innerText = temp + " °C";

                    // Check for heart rate abnormalities
                    checkBpmHealth(pulse);

                    // Update Array & Storage
                    healthHistory.push({ time, pulse, temp });
                    localStorage.setItem('persistentHealthHistory', JSON.stringify(healthHistory));

                    if (document.getElementById('history-container').style.display === "block") {
                        renderHistoryTable();
                    }
                    showSyncAlert();
                }
            } catch (error) { console.error("ThingSpeak Error:", error); }
        }

        fetchHealthData();
        setInterval(fetchHealthData, 15000);

        function exportToCSV() {
            if (healthHistory.length === 0) {
                alert("No records to export yet!");
                return;
            }
            let csvContent = "data:text/csv;charset=utf-8,Time,Pulse (bpm),Temp (C)\n";
            healthHistory.forEach(row => {
                csvContent += `"${row.time}",${row.pulse},${row.temp}\n`;
            });
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "health_history.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // 1. Session Guard: If no user is logged in, send them back to login
// Ensure 'index.html' matches your actual login filename
if (!localStorage.getItem('userRole')) {
    window.location.href = 'index.html'; 
}

// 2. Updated Logout Function
function handleLogout() {
    if(confirm("Are you sure you want to logout?")) {
        // Clear the session
        localStorage.removeItem('userRole'); 
        
        // Redirect to login page
        // IMPORTANT: Change 'index.html' to your actual login file name if different
        window.location.replace('index.html');
    }
}
    </script>
    <script>
    // If user is not logged in, redirect to login page immediately
    if (!localStorage.getItem('userRole')) {
        window.location.replace('index.html');
    }

    function logout() {
        localStorage.removeItem('userRole');
        window.location.replace('index.html');
    }
</script>
</body>
</html>